<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Новости из RSS — краткие карточки</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { max-width: 880px; margin: 24px auto; padding: 16px; }
    h1 { margin: 0 0 8px 0; font-size: 1.6rem; }
    p.hint { margin: 0 0 16px 0; color: #888; }

    textarea, input[type="number"], input[type="text"] {
      width: 100%; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      padding: 10px; border-radius: 10px; border: 1px solid #6663;
      background: transparent; outline: none;
    }
    textarea { min-height: 120px; }
    .row { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    .row > * { flex: 1 1 220px; }

    .actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    button {
      border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600;
      background: #4f46e5; color: #fff; box-shadow: 0 6px 20px #4f46e53a;
    }
    button[disabled] { opacity: .6; cursor: not-allowed; }

    .out { margin-top: 14px; }
    .outbox {
      white-space: normal; word-break: break-word;
      border: 1px solid #6663; border-radius: 10px; padding: 10px; min-height: 140px;
    }
    .footer { margin-top: 18px; color:#888 }
    code { background: #6661; padding: 2px 6px; border-radius: 6px; }

    /* Встроенные стили карточек */
    .news-group{margin-top:18px}
    .news-source{font-weight:700;margin:0 0 8px 0}
    .card{border:1px solid #6663;border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 4px 14px #0001}
    .card .head{display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
    .card a.title{font-weight:700;text-decoration:none}
    .card .date{opacity:.7;font-size:.9em}
    .card .sum{margin-top:8px;line-height:1.5;white-space:pre-wrap}

    /* Индикатор загрузки */
    .loading {
      display: inline-flex; align-items: center; gap: 10px; color: #777;
      padding: 10px; border: 1px dashed #6664; border-radius: 10px; background: #00000006;
    }
    .spinner {
      width: 18px; height: 18px; border-radius: 50%;
      border: 3px solid #9aa0a6; border-top-color: #4f46e5;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Новости из RSS — краткие карточки</h1>
    <p class="hint">Вставьте RSS-ссылки (по одной в строке или через запятую). Будут показаны заголовок-ссылка, дата и краткое резюме.</p>

    <textarea id="rssInput" placeholder="https://lenta.ru/rss/news
https://ria.ru/export/rss2/archive/index.xml">https://lenta.ru/rss/news
https://ria.ru/export/rss2/archive/index.xml</textarea>

    <div class="row">
      <div>
        <label>Сколько брать на ленту:
          <input id="latestN" type="number" min="1" max="300" value="100" />
        </label>
      </div>
      <div>
        <label>Ключевые слова (опц., через запятую):
          <input id="keywords" type="text" value="Россия, экономика, технологии" />
        </label>
      </div>
    </div>

    <div class="actions">
      <button id="btnLoad">Загрузить</button>
      <button id="btnCopy">Копировать</button>
      <button id="btnClear" style="background:#6b7280">Очистить</button>
    </div>

    <div class="out">
      <div id="outBox" class="outbox" placeholder="Здесь появятся статьи..."></div>
    </div>

    <div class="footer">
      Потоковая выдача (SSE) с <code>/api/rss_stream</code>: карточки приходят по мере готовности.
    </div>
  </div>

  <script>
    let es = null;

    function setBusy(busy, text = "Генерирую карточки: скачивание и суммаризация…") {
      const controls = [
        document.getElementById('btnLoad'),
        document.getElementById('btnCopy'),
        document.getElementById('btnClear'),
        document.getElementById('rssInput'),
        document.getElementById('latestN'),
        document.getElementById('keywords'),
      ];
      controls.forEach(el => el.disabled = !!busy);

      const box = document.getElementById('outBox');
      if (busy) {
        box.setAttribute('aria-busy', 'true');
        box.innerHTML = `
          <div class="loading">
            <div class="spinner" aria-hidden="true"></div>
            <div>${text}</div>
          </div>
        `;
      } else {
        box.removeAttribute('aria-busy');
      }
    }

    function buildCardHTML(item) {
      const esc = (s) => (s ?? "").toString()
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;").replace(/'/g, "&#39;");

      const title = esc(item.title || "(без заголовка)");
      const link  = esc(item.link || "");
      const pub   = esc(item.published || "");
      const sum   = esc(item.summary || "");

      const titleHtml = link
        ? `<a class="title" href="${link}" target="_blank" rel="noopener noreferrer">${title}</a>`
        : `<span class="title">${title}</span>`;

      return `
        <div class="card">
          <div class="head">
            ${titleHtml}
            ${pub ? `<span class="date">${pub}</span>` : ""}
          </div>
          <div class="sum">${sum}</div>
        </div>
      `;
    }

    function appendGroupIfMissing(src) {
      const box = document.getElementById('outBox');
      const id = `group_${btoa(unescape(encodeURIComponent(src))).replace(/=/g, "")}`;
      if (!document.getElementById(id)) {
        const group = document.createElement('div');
        group.className = 'news-group';
        group.id = id;
        group.innerHTML = `<div class="news-source">${src}</div>`;
        box.appendChild(group);
      }
      return document.getElementById(id);
    }

    function startStream() {
      const input = document.getElementById('rssInput').value;
      const latestN = Number(document.getElementById('latestN').value) || 100;
      const keywords = (document.getElementById('keywords').value || '')
        .split(',').map(s => s.trim()).filter(Boolean).join(',');

      if (es) { es.close(); es = null; }
      setBusy(true);
      const box = document.getElementById('outBox');
      box.innerHTML = ""; // очистка

      const params = new URLSearchParams({
        urls: input,          // допускаются переносы строк
        latest_n: String(latestN),
        keywords
      });
      const url = `/api/rss_stream?${params.toString()}`;

      es = new EventSource(url);

      es.addEventListener('start', (e) => {
        const data = JSON.parse(e.data);
        const total = data.total || 0;
        if (total === 0) {
          box.innerHTML = `<div class="muted">Нет записей по фильтрам.</div>`;
        } else {
          box.innerHTML = `
            <div class="loading">
              <div class="spinner" aria-hidden="true"></div>
              <div>Нашли ${total} записей. Начинаю суммаризацию…</div>
            </div>
          `;
        }
      });

      es.addEventListener('card', (e) => {
        const data = JSON.parse(e.data);
        if (box.querySelector('.loading')) box.innerHTML = "";

        const group = appendGroupIfMissing(data.src || "Источник");
        group.insertAdjacentHTML('beforeend', buildCardHTML(data));

        if (data.progress) {
          const { done, total } = data.progress;
          document.title = `(${done}/${total}) Новости из RSS — краткие карточки`;
        }
      });

      es.addEventListener('done', (e) => {
        const data = JSON.parse(e.data || "{}");
        setBusy(false);
        if (!data.ok) {
          box.innerHTML = `<div class="loading" style="border-color:#e11d48;color:#e11d48">
            <div class="spinner" style="border-color:#fca5a5;border-top-color:#e11d48"></div>
            <div>Ошибка: ${data.error || "unknown"}</div>
          </div>`;
        }
        if (es) { es.close(); es = null; }
        document.title = `Новости из RSS — краткие карточки`;
      });

      es.onerror = () => {
        setBusy(false, "");
        if (es) { es.close(); es = null; }
        box.insertAdjacentHTML('beforeend', `<div class="loading" style="border-color:#e11d48;color:#e11d48">
          <div class="spinner" style="border-color:#fca5a5;border-top-color:#e11d48"></div>
          <div>Ошибка соединения</div>
        </div>`);
      };
    }

    function copyOut() {
      const el = document.getElementById('outBox');
      const range = document.createRange();
      range.selectNodeContents(el);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      try { document.execCommand('copy'); } catch {}
      sel.removeAllRanges();
    }

    function clearOut() {
      document.getElementById('outBox').innerHTML = '';
    }

    document.getElementById('btnLoad').addEventListener('click', startStream);
    document.getElementById('btnCopy').addEventListener('click', copyOut);
    document.getElementById('btnClear').addEventListener('click', clearOut);

    // Ctrl/Cmd+Enter — загрузить
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') startStream();
    });

    // Можно автозапустить на загрузке:
    // window.addEventListener('DOMContentLoaded', startStream);
  </script>
</body>
</html>
