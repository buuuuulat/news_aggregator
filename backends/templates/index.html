<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ù–æ–≤–æ—Å—Ç–∏ –∏–∑ RSS ‚Äî –∫—Ä–∞—Ç–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { max-width: 880px; margin: 24px auto; padding: 16px; }
    h1 { margin: 0 0 8px 0; font-size: 1.6rem; }
    p.hint { margin: 0 0 16px 0; color: #888; }

    textarea, input[type="number"], input[type="text"] {
      width: 100%; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      padding: 10px; border-radius: 10px; border: 1px solid #6663;
      background: transparent; outline: none;
    }
    textarea { min-height: 120px; }
    .row { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    .row > * { flex: 1 1 220px; }

    .actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    button {
      border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600;
      background: #4f46e5; color: #fff; box-shadow: 0 6px 20px #4f46e53a;
    }
    button[disabled] { opacity: .6; cursor: not-allowed; }

    .out { margin-top: 14px; }
    .outbox {
      white-space: normal; word-break: break-word;
      border: 1px solid #6663; border-radius: 10px; padding: 10px; min-height: 140px;
    }
    .footer { margin-top: 18px; color:#888 }
    code { background: #6661; padding: 2px 6px; border-radius: 6px; }

    /* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ (—á—Ç–æ–± –≤—ã–≥–ª—è–¥–µ–ª–æ –∫—Ä–∞—Å–∏–≤–æ –∏–∑ –∫–æ—Ä–æ–±–∫–∏) */
    .news-group{margin-top:18px}
    .news-source{font-weight:700;margin:0 0 8px 0}
    .card{border:1px solid #6663;border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 4px 14px #0001}
    .card .head{display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
    .card a.title{font-weight:700;text-decoration:none}
    .card .date{opacity:.7;font-size:.9em}
    .card .sum{margin-top:8px;line-height:1.5;white-space:pre-wrap}

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading {
      display: inline-flex; align-items: center; gap: 10px; color: #777;
      padding: 10px; border: 1px dashed #6664; border-radius: 10px; background: #00000006;
    }
    .spinner {
      width: 18px; height: 18px; border-radius: 50%;
      border: 3px solid #9aa0a6; border-top-color: #4f46e5;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>–ù–æ–≤–æ—Å—Ç–∏ –∏–∑ RSS ‚Äî –∫—Ä–∞—Ç–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h1>
    <p class="hint">–í—Å—Ç–∞–≤—å—Ç–µ RSS-—Å—Å—ã–ª–∫–∏ (–ø–æ –æ–¥–Ω–æ–π –≤ —Å—Ç—Ä–æ–∫–µ –∏–ª–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é). –ë—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∑–∞–≥–æ–ª–æ–≤–æ–∫-—Å—Å—ã–ª–∫–∞, –¥–∞—Ç–∞ –∏ –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è).</p>

    <textarea id="rssInput" placeholder="https://lenta.ru/rss/news
https://ria.ru/export/rss2/archive/index.xml">https://lenta.ru/rss/news
https://ria.ru/export/rss2/archive/index.xml</textarea>

    <div class="row">
      <div>
        <label>–°–∫–æ–ª—å–∫–æ –±—Ä–∞—Ç—å –Ω–∞ –ª–µ–Ω—Ç—É:
          <input id="latestN" type="number" min="1" max="300" value="100" />
        </label>
      </div>
      <div>
        <label>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–æ–ø—Ü., —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):
          <input id="keywords" type="text" value="–†–æ—Å—Å–∏—è, —ç–∫–æ–Ω–æ–º–∏–∫–∞, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏" />
        </label>
      </div>
    </div>

    <div class="actions">
      <button id="btnLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <button id="btnCopy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button id="btnClear" style="background:#6b7280">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="out">
      <div id="outBox" class="outbox" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Å—Ç–∞—Ç—å–∏..."></div>
    </div>

    <div class="footer">
        <br><br>‚ùÑÔ∏èüåµ This project is created by BMSTU Students
    </div>
  </div>
  <script>
    // –¥–ª—è –æ—Ç–º–µ–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å" –ø–æ–≤—Ç–æ—Ä–Ω–æ)
    let currentController = null;

    function setBusy(busy) {
      const controls = [document.getElementById('btnLoad'), document.getElementById('btnCopy'), document.getElementById('btnClear'),
                        document.getElementById('rssInput'), document.getElementById('latestN'), document.getElementById('keywords')];
      controls.forEach(el => el.disabled = !!busy);

      const box = document.getElementById('outBox');
      if (busy) {
        box.setAttribute('aria-busy', 'true');
        box.innerHTML = `
          <div class="loading">
            <div class="spinner" aria-hidden="true"></div>
            <div>–ì–æ—Ç–æ–≤–∏–º —Å—Ç–∞—Ç—å–∏ –¥–ª—è –í–∞—Å...<br>–°–∫–∞—á–∏–≤–∞–µ–º –∏ —Å–∂–∏–º–∞–µ–º —Ç–µ–∫—Å—Ç</div>
          </div>
        `;
      } else {
        box.removeAttribute('aria-busy');
      }
    }

    async function fetchRSS() {
      const input = document.getElementById('rssInput').value;
      const latestN = Number(document.getElementById('latestN').value) || 100;
      const keywords = (document.getElementById('keywords').value || '')
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);

      // –æ—Ç–º–µ–Ω–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (currentController) currentController.abort();
      currentController = new AbortController();

      setBusy(true);
      const box = document.getElementById('outBox');

      try {
        const res = await fetch('/api/rss_html', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ urls: input, latest_n: latestN, keywords }),
          signal: currentController.signal
        });

        const html = await res.text();
        box.innerHTML = html || `<div class="muted">–ü—É—Å—Ç–æ</div>`;
        // –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∞—á–∞–ª—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–µ—Å–ª–∏ –±–ª–æ–∫ –Ω–∏–∂–µ —ç–∫—Ä–∞–Ω–∞)
        box.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (err) {
        if (err?.name === 'AbortError') {
          // –∑–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω ‚Äî —Ç–∏—Ö–æ –≤—ã—Ö–æ–¥–∏–º
        } else {
          box.innerHTML = `<div class="loading" style="border-color:#e11d48;color:#e11d48">
            <div class="spinner" style="border-color:#fca5a5;border-top-color:#e11d48"></div>
            <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${String(err)}</div>
          </div>`;
        }
      } finally {
        setBusy(false);
        currentController = null;
      }
    }

    function copyOut() {
      const el = document.getElementById('outBox');
      const range = document.createRange();
      range.selectNodeContents(el);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      try { document.execCommand('copy'); } catch {}
      sel.removeAllRanges();
    }

    function clearOut() {
      document.getElementById('outBox').innerHTML = '';
    }

    // —Å–æ–±—ã—Ç–∏—è
    document.getElementById('btnLoad').addEventListener('click', fetchRSS);
    document.getElementById('btnCopy').addEventListener('click', copyOut);
    document.getElementById('btnClear').addEventListener('click', clearOut);

    // Ctrl/Cmd+Enter ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        fetchRSS();
      }
    });

    // –º–æ–∂–Ω–æ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–µ—Å–ª–∏ –Ω–∞–¥–æ)
    // window.addEventListener('DOMContentLoaded', () => fetchRSS());
  </script>
</body>
</html>
